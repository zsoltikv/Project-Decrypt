using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using TMPro;
using UnityEngine.UI;
using UnityEngine.SceneManagement;

public class MalwareDefenseManager : MonoBehaviour
{
    [Header("References")]
    public GameObject virusPrefab;
    public Transform serverTransform;
    public RawImage serverImage;
    public TMP_Text scoreText;
    public TMP_Text healthText;
    public Canvas endCanvas;
    public Button endButton;
    public TMP_Text endText;
    public TMP_Text endButtonText;

    [Header("Spawn Settings")]
    public float spawnDistanceFromEdge = 0.5f;
    public int maxSimultaneous = 30;

    private int score = 0;
    private int scoreNeeded = 25;
    private float serverMaxHealth = 100f;
    private float serverHealth = 1f;
    private float spawnInterval = 1.2f;
    private float speedMultiplier = 1.0f;
    private List<GameObject> activeViruses = new List<GameObject>();

    void Start()
    {
        switch (GameSettingsManager.Instance.currentDifficulty)
        {
            case GameSettingsManager.Difficulty.Easy:
                speedMultiplier = 1.0f;
                serverMaxHealth = 100;
                spawnInterval = 1.2f;
                scoreNeeded = 500;
                break;
            case GameSettingsManager.Difficulty.Normal:
                speedMultiplier = 1.4f;
                serverMaxHealth = 80;
                spawnInterval = 1.0f;
                scoreNeeded = 1000;
                break;
            case GameSettingsManager.Difficulty.Hard:
                speedMultiplier = 1.8f;
                serverMaxHealth = 60;
                spawnInterval = 0.8f;
                scoreNeeded = 1500;
                break;
            default:
                break;
        }

        serverHealth = serverMaxHealth;
        UpdateScoreUI();
        StartCoroutine(SpawnRoutine());
    }

    void UpdateScoreUI()
    {
        if (healthText) healthText.text = $"HEALTH: {serverHealth} / {serverMaxHealth}";
        if (scoreText) scoreText.text = $"SCORE: {score} / {scoreNeeded}";
    }

    IEnumerator SpawnRoutine()
    {
        while (true)
        {
            if (activeViruses.Count < maxSimultaneous)
                SpawnVirus();

            yield return new WaitForSeconds(Mathf.Max(0.15f, spawnInterval));
        }
    }

    void SpawnVirus()
    {
        Vector2 spawnPos = GetRandomSpawnPositionOutsideScreen();
        GameObject go = Instantiate(virusPrefab, spawnPos, Quaternion.identity);
        Virus v = go.GetComponent<Virus>();
        if (v != null)
            v.Initialize(serverTransform.position, speedMultiplier, this);

        activeViruses.Add(go);
    }

    Vector3 GetRandomSpawnPositionOutsideScreen()
    {
        float x = 0f, y = 0f;
        int side = Random.Range(0, 4);
        switch (side)
        {
            case 0: x = Random.Range(-70f, 2630f); y = 1530f; break;
            case 1: x = Random.Range(-70f, 2630f); y = -80f; break;
            case 2: x = -70f; y = Random.Range(-80f, 1530f); break;
            case 3: x = 2630f; y = Random.Range(-80f, 1530f); break;
        }
        return new Vector3(x, y, 0f);
    }

    public void OnVirusReachedServer(GameObject virus, float damage)
    {
        if (virus != null) Destroy(virus);
        activeViruses.Remove(virus);

        serverHealth -= damage;
        serverHealth = Mathf.Max(0f, serverHealth);
        serverImage.color = (serverHealth / serverMaxHealth <= 0.5f)
            ? Color.Lerp(Color.red, Color.yellow, Mathf.Clamp01(serverHealth / serverMaxHealth * 2f))
            : Color.Lerp(Color.yellow, Color.green, Mathf.Clamp01((serverHealth / serverMaxHealth - 0.5f) * 2f));

        UpdateScoreUI();

        if (serverHealth <= 0f && !endCanvas.enabled) OnServerDestroyed();
    }

    public void OnVirusDestroyed(GameObject virus, int points)
    {
        if (virus != null) Destroy(virus);
        activeViruses.Remove(virus);
        if(score < scoreNeeded) score += points;
        UpdateScoreUI();

        if(score >= scoreNeeded && !endCanvas.enabled)
        {
            StopAllCoroutines();
            ClearViruses();
            endButton.onClick.RemoveAllListeners();
            endButton.onClick.AddListener(() =>
            {
                SceneManager.LoadScene("GameScene");
            });

            endText.text = "Server successfully defended.";
            endButtonText.text = "Continue";
            endCanvas.enabled = true;
        }
    }

    void ClearViruses()
    {
        foreach (GameObject virus in activeViruses)
        {
            Destroy(virus);
        }
    }

    void Restart()
    {
        score = 0;
        serverHealth = serverMaxHealth;
        serverImage.color = Color.green;
        ClearViruses();
        activeViruses.Clear();
        UpdateScoreUI();
        endCanvas.enabled = false;
        StartCoroutine(SpawnRoutine());
    }

    void OnServerDestroyed()
    {
        StopAllCoroutines();
        ClearViruses();
        endButton.onClick.RemoveAllListeners();
        endButton.onClick.AddListener(() => {
            Restart();
        });

        endText.text = "The server has been infected.";
        endButtonText.text = "Restart";
        endCanvas.enabled = true;
    }

    public void RemoveVirusFromList(GameObject virus)
    {
        if (activeViruses.Contains(virus)) activeViruses.Remove(virus);
    }
}
