using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using TMPro;
using UnityEngine.UI;
using UnityEngine.SceneManagement;

public class MalwareDefenseManager : MonoBehaviour
{
    [Header("References")]
    public GameObject virusPrefab;
    public Transform serverTransform;
    public RawImage serverImage;
    public TMP_Text scoreText;
    public TMP_Text healthText;
    public GameObject winPanel;

    [Header("Spawn Settings")]
    public float spawnDistanceFromEdge = 0.5f;
    public int maxSimultaneous = 30;

    private int score = 0;
    private int scoreNeeded = 25;
    private float serverMaxHealth = 100f;
    private float serverHealth = 1f;
    private float spawnInterval = 1.2f;
    private float speedMultiplier = 1.0f;
    private List<GameObject> activeViruses = new List<GameObject>();

    void Start()
    {
        if (winPanel != null)
            winPanel.SetActive(false);

        switch (GameSettingsManager.Difficulty.Easy)
        {
            case GameSettingsManager.Difficulty.Easy:
                speedMultiplier = 1.0f;
                serverMaxHealth = 100;
                spawnInterval = 1.2f;
                scoreNeeded = 1;
                break;
            case GameSettingsManager.Difficulty.Normal:
                speedMultiplier = 1.4f;
                serverMaxHealth = 80;
                spawnInterval = 1.0f;
                scoreNeeded = 1000;
                break;
            case GameSettingsManager.Difficulty.Hard:
                speedMultiplier = 1.8f;
                serverMaxHealth = 60;
                spawnInterval = 0.8f;
                scoreNeeded = 1500;
                break;
        }

        serverHealth = serverMaxHealth;
        UpdateScoreUI();
        StartCoroutine(SpawnRoutine());
    }

    void UpdateScoreUI()
    {
        if (healthText) healthText.text = $"HEALTH: {serverHealth} / {serverMaxHealth}";
        if (scoreText) scoreText.text = $"SCORE: {score} / {scoreNeeded}";
    }

    IEnumerator SpawnRoutine()
    {
        while (true)
        {
            if (activeViruses.Count < maxSimultaneous)
                SpawnVirus();

            yield return new WaitForSeconds(Mathf.Max(0.15f, spawnInterval));
        }
    }

    void SpawnVirus()
    {
        Vector2 spawnPos = GetRandomSpawnPositionOutsideScreen();
        GameObject go = Instantiate(virusPrefab, spawnPos, Quaternion.identity);
        Virus v = go.GetComponent<Virus>();
        if (v != null)
            v.Initialize(serverTransform.position, speedMultiplier, this);

        activeViruses.Add(go);
    }

    Vector3 GetRandomSpawnPositionOutsideScreen()
    {
        float x = 0f, y = 0f;
        int side = Random.Range(0, 4);
        switch (side)
        {
            case 0: x = Random.Range(-70f, 2630f); y = 1530f; break;
            case 1: x = Random.Range(-70f, 2630f); y = -80f; break;
            case 2: x = -70f; y = Random.Range(-80f, 1530f); break;
            case 3: x = 2630f; y = Random.Range(-80f, 1530f); break;
        }
        return new Vector3(x, y, 0f);
    }

    public void OnVirusReachedServer(GameObject virus, float damage)
    {
        if (virus != null) Destroy(virus);
        activeViruses.Remove(virus);

        serverHealth -= damage;
        serverHealth = Mathf.Max(0f, serverHealth);
        serverImage.color = (serverHealth / serverMaxHealth <= 0.5f)
            ? Color.Lerp(Color.red, Color.yellow, Mathf.Clamp01(serverHealth / serverMaxHealth * 2f))
            : Color.Lerp(Color.yellow, Color.green, Mathf.Clamp01((serverHealth / serverMaxHealth - 0.5f) * 2f));

        UpdateScoreUI();

        if (serverHealth <= 0f && winPanel != null && !winPanel.activeSelf)
        {
            StopAllCoroutines();
            ClearViruses();
            StartCoroutine(ShowWinPanel());
        }
    }

    public void OnVirusDestroyed(GameObject virus, int points)
    {
        if (virus != null) Destroy(virus);
        activeViruses.Remove(virus);

        if (score < scoreNeeded) score += points;
        UpdateScoreUI();

        if (score >= scoreNeeded && winPanel != null && !winPanel.activeSelf)
        {
            StopAllCoroutines();
            ClearViruses();
            StartCoroutine(ShowWinPanel());
        }
    }

    void ClearViruses()
    {
        foreach (GameObject virus in activeViruses)
            Destroy(virus);
        activeViruses.Clear();
    }

    public void RemoveVirusFromList(GameObject virus)
    {
        if (activeViruses.Contains(virus))
            activeViruses.Remove(virus);
    }

    IEnumerator ShowWinPanel()
    {
        // 1 másodperces várakozás a panel elõtt
        yield return new WaitForSeconds(1f);

        winPanel.SetActive(true);

        CanvasGroup cg = winPanel.GetComponent<CanvasGroup>();
        if (cg == null)
            cg = winPanel.AddComponent<CanvasGroup>();

        cg.alpha = 0f;
        winPanel.transform.localScale = Vector3.one * 0.4f;

        float duration = 0.4f;
        float time = 0f;

        while (time < duration)
        {
            time += Time.deltaTime;
            float t = time / duration;

            cg.alpha = Mathf.Lerp(0f, 1f, t);
            winPanel.transform.localScale = Vector3.Lerp(Vector3.one * 0.4f, Vector3.one, Mathf.Sin(t * Mathf.PI * 0.5f));

            yield return null;
        }

        winPanel.transform.localScale = Vector3.one;
        cg.alpha = 1f;

        // 2 másodperc várakozás a panel láthatóságában
        yield return new WaitForSeconds(2f);

        if (GameSettingsManager.Instance != null)
            GameSettingsManager.Instance.completedApps.Add("MalwareDefense");

        SceneManager.LoadScene("GameScene");
    }
}